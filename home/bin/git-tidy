#!/usr/bin/env bash
set -euo pipefail

# Delete local branches and worktrees that have been merged or deleted on the remote.

if ! command -v wt >/dev/null 2>&1; then
    echo "error: wt (worktrunk) is required but not installed"
    exit 1
fi

git fetch -p

branches=$(wt list --format=json --branches | jq -r '
    .[] | select(
        (.is_main | not) and
        (.is_current | not) and
        (.main_state == "integrated" or .main_state == "empty" or .main_state == "same_commit" or (.main_state == "diverged" and (has("remote") | not)))
    ) | .branch
')

if [ -z "$branches" ]; then
    echo "Nothing to clean up."
    exit 0
fi

echo "Delete these merged branches and their worktrees? [y/N]"
echo "$branches"
read -r confirm

if [[ "$confirm" =~ ^[Yy]$ ]]; then
    echo "$branches" | xargs wt remove --force --force-delete --yes
    echo "Cleanup complete."
else
    echo "Cancelled."
fi
