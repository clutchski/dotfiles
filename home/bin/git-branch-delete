#!/usr/bin/env bash
set -euo pipefail

# Delete git branches both locally and on origin with confirmation.
# Use -f to ignore errors when remote branch doesn't exist.

force=false
yes=false
branches=()
for arg in "$@"; do
  case "$arg" in
    -f) force=true ;;
    -y) yes=true ;;
    *) branches+=("$arg") ;;
  esac
done

if [ ${#branches[@]} -eq 0 ]; then
  echo "Usage: git branch-delete [-f] [-y] <branch1> [branch2] [branch3] ..."
  exit 1
fi

if [ "$yes" = false ]; then
  echo -e "Are you sure you want to delete the following branches locally and on origin? [y/N]"
  for branch in "${branches[@]}"; do
    echo "  - ${branch}"
  done
  read -r confirm
else
  confirm=y
fi

if [[ "$confirm" =~ ^[Yy]$ ]]; then
  for branch in "${branches[@]}"; do
    echo "Deleting branch '${branch}'..."
    git branch -D "${branch}"
    if ! git push origin --delete "${branch}" 2>/dev/null; then
      if [ "$force" = true ]; then
        echo "Remote branch '${branch}' not found, skipping."
      else
        echo "error: remote branch '${branch}' does not exist. Use -f to ignore." >&2
        exit 1
      fi
    fi
    echo "Branch '${branch}' deleted"
  done
else
  echo "Operation cancelled."
fi
